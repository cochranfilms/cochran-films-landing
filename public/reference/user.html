<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard | Cochran Films</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root { --brand-gold:#FFB200; --text:#e5e7eb; --muted:#94a3b8; --bg:#0f172a; --card:rgba(15,23,42,0.7); --border:1px solid rgba(99,102,241,0.25); --radius:16px; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg, rgba(15,23,42,0.8), rgba(2,6,23,0.9));color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrapper{max-width:1100px;margin:0 auto;padding:80px 20px}
    h1{margin:0 0 8px;font-size:32px;font-weight:900}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
    .card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:18px}
    .card h3{margin:0 0 10px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid rgba(99,102,241,0.18);border-radius:12px;background:rgba(2,6,23,0.35)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid rgba(99,102,241,0.25);color:var(--text);text-decoration:none;cursor:pointer;background:rgba(99,102,241,0.12)}
    .btn:hover{border-color:rgba(99,102,241,0.45)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(99,102,241,0.25);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(99,102,241,0.25);background:#0b1220;color:var(--text)}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:10px 0 14px}
  </style>
</head>
<body>
  <div class="wrapper">
    <section class="card" style="margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; gap:16px; background:linear-gradient(135deg, rgba(99,102,241,0.15), rgba(255,178,0,0.12));">
      <div style="flex:1">
        <h2 style="margin:0 0 6px;font-size:22px;font-weight:900">Welcome</h2>
        <div class="muted">Sign in to sync favorites, comments, and invoices across devices</div>
      </div>
      <form id="loginForm" style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="min-width:220px">
            <label class="muted" for="loginEmail" style="display:block;font-size:12px;margin:0 0 4px">Email</label>
            <input id="loginEmail" type="email" placeholder="you@example.com" required />
          </div>
          <div style="min-width:200px">
            <label class="muted" for="loginPassword" style="display:block;font-size:12px;margin:0 0 4px">Password</label>
            <input id="loginPassword" type="password" placeholder="••••••••" required />
          </div>
          <div style="min-width:200px" id="nameContainer" hidden>
            <label class="muted" for="loginName" style="display:block;font-size:12px;margin:0 0 4px">Full name (sign up)</label>
            <input id="loginName" type="text" placeholder="Your name" />
          </div>
        </div>
        <div class="row" style="gap:8px">
          <button type="submit" class="btn" id="signinBtn"><i class="fas fa-right-to-bracket"></i> Sign In</button>
          <button type="button" class="btn" id="toggleSignup"><i class="fas fa-user-plus"></i> Create Account</button>
          <button type="button" class="btn" id="signoutBtn" style="display:none"><i class="fas fa-right-from-bracket"></i> Sign Out</button>
        </div>
      </form>
    </section>
    <header style="margin-bottom:16px">
      <h1>User Dashboard</h1>
      <div class="muted">Manage your profile, invoices, favorites, and comments</div>
    </header>

    <section class="grid">
      <div class="card">
        <div class="section-title"><h3><i class="fas fa-user"></i> Profile</h3><span class="pill" id="authStatus">Guest</span></div>
        <div class="row">
          <input id="profileName" placeholder="Full name" />
          <input id="profileEmail" placeholder="Email" />
        </div>
        <div style="margin-top:12px" class="row">
          <button class="btn" id="saveProfile"><i class="fas fa-save"></i> Save Profile</button>
          <a class="btn" href="/blog.html"><i class="fas fa-newspaper"></i> Go to Blog</a>
        </div>
      </div>

      <div class="card" style="grid-column: span 2">
        <div class="section-title"><h3><i class="fas fa-file-invoice-dollar"></i> Invoices</h3>
          <a class="pill" href="/services.html"><i class="fas fa-cart-plus"></i> Shop Services</a>
        </div>
        <div id="invoiceList" class="list"></div>
      </div>

      <div class="card">
        <div class="section-title"><h3><i class="fas fa-bookmark"></i> Favorites</h3>
          <span class="pill" id="favoritesCount">0 saved</span></div>
        <div id="favoritesList" class="list"></div>
      </div>

      <div class="card" style="grid-column: span 2">
        <div class="section-title"><h3><i class="fas fa-comments"></i> My Comments</h3></div>
        <div id="commentsList" class="list"></div>
      </div>
    </section>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase if config is provided globally
    window.__CF_FIREBASE = window.__CF_FIREBASE || {};
    try {
      if (!firebase.apps.length && window.__CF_FIREBASE_CONFIG) {
        firebase.initializeApp(window.__CF_FIREBASE_CONFIG);
      }
      if (firebase.apps.length) {
        window.__CF_FIREBASE.app = firebase.app();
        window.__CF_FIREBASE.db = firebase.firestore();
        window.__CF_FIREBASE.auth = firebase.auth();
      }
    } catch(e) { console.warn('Firebase init skipped:', e); }

    // Lightweight client-side data layer (replace with Firebase later)
    const UserAPI = {
      _k: 'cf_user_data_v1',
      _read(){ try{return JSON.parse(localStorage.getItem(this._k)||'{}')}catch{return {}} },
      _write(v){ localStorage.setItem(this._k, JSON.stringify(v)) },
      getUser(){ const s=this._read(); return s.user||null },
      setUser(user){ const s=this._read(); s.user=user; this._write(s) },
      addFavorite(post){ const s=this._read(); s.favorites=s.favorites||[]; if(!s.favorites.find(p=>p.url===post.url)){ s.favorites.unshift({...post, savedAt:Date.now()}) } this._write(s) },
      removeFavorite(url){ const s=this._read(); s.favorites=(s.favorites||[]).filter(p=>p.url!==url); this._write(s) },
      listFavorites(){ const s=this._read(); return s.favorites||[] },
      addComment(entity){ const s=this._read(); s.comments=s.comments||[]; s.comments.unshift({...entity, createdAt:Date.now()}); this._write(s) },
      listComments(){ const s=this._read(); return s.comments||[] },
      listInvoices(){ const s=this._read(); return s.invoices||[] },
      addInvoice(inv){ const s=this._read(); s.invoices=s.invoices||[]; s.invoices.unshift(inv); this._write(s) }
    };

    function renderProfile(){
      const u=UserAPI.getUser();
      document.getElementById('authStatus').textContent = u? 'Signed In' : 'Guest';
      document.getElementById('profileName').value = u?.name||'';
      document.getElementById('profileEmail').value = u?.email||'';
    }
    function renderFavorites(){
      const list=document.getElementById('favoritesList'); const favs=UserAPI.listFavorites();
      document.getElementById('favoritesCount').textContent = `${favs.length} saved`;
      list.innerHTML = favs.length? favs.map(p=>`
        <div class="item">
          <div style="display:flex;gap:10px;align-items:center;max-width:70%">
            <i class="fas fa-bookmark" style="color:var(--brand-gold)"></i>
            <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.title||p.url}</div>
          </div>
          <div class="row">
            <a class="btn" href="${p.url}" target="_blank" rel="noopener"><i class="fas fa-external-link"></i> Open</a>
            <button class="btn" data-remove="${p.url}"><i class="fas fa-trash"></i></button>
          </div>
        </div>`).join('') : '<div class="muted">No favorites yet</div>';
      list.querySelectorAll('[data-remove]').forEach(btn=>btn.onclick=()=>{UserAPI.removeFavorite(btn.dataset.remove); renderFavorites();});
    }
    function renderInvoices(){
      const list=document.getElementById('invoiceList'); const invs=UserAPI.listInvoices();
      list.innerHTML = invs.length? invs.map(i=>`
        <div class="item">
          <div style="display:flex;flex-direction:column">
            <strong>${i.title||'Invoice'}</strong>
            <span class="muted">${new Date(i.createdAt||Date.now()).toLocaleString()}</span>
          </div>
          <div class="row">
            <span class="pill"><i class="fas fa-dollar-sign"></i> ${i.total ? `$${Number(i.total).toLocaleString()}` : '—'}</span>
            ${i.hostedInvoiceUrl ? `<a class="btn" href="${i.hostedInvoiceUrl}" target="_blank" rel="noopener"><i class="fas fa-file-invoice-dollar"></i> View</a>`:''}
          </div>
        </div>`).join('') : '<div class="muted">No invoices yet</div>';
    }
    function renderComments(){
      const list=document.getElementById('commentsList'); const cs=UserAPI.listComments();
      list.innerHTML = cs.length? cs.map(c=>`
        <div class="item">
          <div style="display:flex;flex-direction:column;max-width:70%">
            <strong>${c.postTitle||'Post'}</strong>
            <span class="muted">${new Date(c.createdAt).toLocaleString()}</span>
            <div style="margin-top:6px">${c.text}</div>
          </div>
          <a class="btn" href="${c.postUrl}" target="_blank" rel="noopener"><i class="fas fa-external-link"></i> Open</a>
        </div>`).join('') : '<div class="muted">No comments yet</div>';
    }

    document.getElementById('saveProfile').onclick = async ()=>{
      const name=document.getElementById('profileName').value.trim();
      const email=document.getElementById('profileEmail').value.trim();
      const auth = window.__CF_FIREBASE.auth;
      if (auth && auth.currentUser) {
        const db = window.__CF_FIREBASE.db;
        await db.collection('Users').doc(auth.currentUser.uid).set({ displayName: name, email }, { merge: true });
        UserAPI.setUser({ name, email, uid: auth.currentUser.uid });
      } else {
        UserAPI.setUser({ name, email, uid: 'local-'+btoa(email||Date.now()) });
      }
      renderProfile();
    };

    // Firebase Auth UI logic
    (function authUI(){
      const auth = window.__CF_FIREBASE.auth;
      const db = window.__CF_FIREBASE.db;
      const form = document.getElementById('loginForm');
      const toggleSignup = document.getElementById('toggleSignup');
      const nameContainer = document.getElementById('nameContainer');
      const signoutBtn = document.getElementById('signoutBtn');
      let isSignup = false;

      function setMode(signup){
        isSignup = signup; nameContainer.hidden = !signup;
        document.getElementById('signinBtn').innerHTML = signup ? '<i class="fas fa-user-plus"></i> Create Account' : '<i class="fas fa-right-to-bracket"></i> Sign In';
      }
      toggleSignup.addEventListener('click', ()=> setMode(!isSignup));

      form.addEventListener('submit', async (e)=>{
        e.preventDefault(); if (!auth) { alert('Firebase not configured.'); return; }
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const fullName = document.getElementById('loginName').value.trim();
        try{
          let cred;
          if (isSignup) {
            cred = await auth.createUserWithEmailAndPassword(email, password);
            await cred.user.updateProfile({ displayName: fullName||email });
          } else {
            cred = await auth.signInWithEmailAndPassword(email, password);
          }
          // Upsert profile
          await db.collection('Users').doc(cred.user.uid).set({
            email: cred.user.email || email,
            displayName: cred.user.displayName || fullName || email,
            photoURL: cred.user.photoURL || '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });
        }catch(err){ alert(err.message); }
      });

      signoutBtn.addEventListener('click', ()=> auth?.signOut());

      let unsubFavs = null, unsubComments = null;
      auth?.onAuthStateChanged((u)=>{
        const signedIn = Boolean(u);
        document.getElementById('authStatus').textContent = signedIn ? 'Signed In' : 'Guest';
        signoutBtn.style.display = signedIn ? 'inline-flex' : 'none';
        if (signedIn) {
          // Reflect in profile fields
          document.getElementById('profileEmail').value = u.email||'';
          document.getElementById('profileName').value = u.displayName||'';
          UserAPI.setUser({ name: u.displayName||'', email: u.email||'', uid: u.uid });
          // Live favorites/comments
          try{
            unsubFavs?.(); unsubComments?.();
            unsubFavs = db.collection('Users').doc(u.uid).collection('favorites').orderBy('savedAt','desc').onSnapshot(snap=>{
              const favs = snap.docs.map(d => d.data());
              const list=document.getElementById('favoritesList');
              document.getElementById('favoritesCount').textContent = `${favs.length} saved`;
              list.innerHTML = favs.length? favs.map(p=>`
                <div class="item">
                  <div style="display:flex;gap:10px;align-items:center;max-width:70%">
                    <i class="fas fa-bookmark" style="color:var(--brand-gold)"></i>
                    <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.title||p.url}</div>
                  </div>
                  <div class="row">
                    <a class="btn" href="${p.url}" target="_blank" rel="noopener"><i class="fas fa-external-link"></i> Open</a>
                  </div>
                </div>`).join('') : '<div class="muted">No favorites yet</div>';
            });
            unsubComments = db.collection('Users').doc(u.uid).collection('comments').orderBy('createdAt','desc').onSnapshot(snap=>{
              const cs = snap.docs.map(d => d.data());
              const list=document.getElementById('commentsList');
              list.innerHTML = cs.length? cs.map(c=>`
                <div class="item">
                  <div style="display:flex;flex-direction:column;max-width:70%">
                    <strong>${c.postTitle||'Post'}</strong>
                    <span class="muted">${new Date(c.createdAt).toLocaleString()}</span>
                    <div style="margin-top:6px">${c.text}</div>
                  </div>
                  <a class="btn" href="${c.postUrl}" target="_blank" rel="noopener"><i class="fas fa-external-link"></i> Open</a>
                </div>`).join('') : '<div class="muted">No comments yet</div>';
            });
          }catch(e){ console.warn(e); }
        } else {
          unsubFavs?.(); unsubComments?.();
          renderFavorites(); renderComments();
        }
      });
    })();

    // Initial render
    renderProfile(); renderFavorites(); renderInvoices(); renderComments();

    // Expose API for other pages to add data (favorites, invoices, comments)
    window.__CFUserAPI = UserAPI;
  </script>
</body>
</html>
